digraph sphil {
        node [style="rounded,filled",color=black,shape=box,fillcolor=white];
        graph [style=filled, splines=line, overlap=false];
        subgraph cluster_ce {
                label="       Cold Electronics (only subset shown)          ";
                graph[color=darkorange1, ranksep=1.8, nodesep=.5];
                subgraph cluster_ceapa2{
                        label="APA i+3";
                        graph[color=darkorange];
                        CEi[label="FEMBs"];
                        WIBi[label="WIBs"];
                }
                subgraph cluster_ceapa4 {
                        label="APA i+1";
                        graph[color=darkorange];
                        CE1[label="FEMBs"];
                        WIB1[label="WIBs"];
                }
                subgraph cluster_ceapa1 {
                        label="APA i+2";
                        graph[color=darkorange];
                        CE2[label="FEMBs"];
                        WIB2[label="WIBs"];
                }
                subgraph cluster_ceapa3 {
                        label="APA i";
                        graph[color=darkorange];
                        CEj[label="FEMBs"];
                        WIBj[label="WIBs"];
                }
        }
        subgraph cluster_daq {
                label="Single-Phase DAQ Data and Trigger Flow (only 2 APAs shown)";
                labelloc=bottom;
                graph[color=deeppink4];                

                trig[shape=diamond,label="Single-Phase\nModule-Level\nTrigger Logic"];

                subgraph cluster_apa {
                        label="APA 1 Data and Trigger Flow";
                        graph[color=deeppink3];
                        subgraph cluster_fe {
                                label="Pre-Processing system";
                                graph[color=deeppink1];
                                fe[label="DAQ Front End"];
                                pipe[label="Trigger Primitive\nPipeline"];
                        }
                        subgraph cluster_buf {
                                label="Buffering system";
                                labelloc=top;
                                graph[color=deeppink1, ranksep=.8, nodesep=.25];
                                buf[label="10s RAM\nbuffer"];
                                snb[label="SNB dump"];
                                ro[shape=hexagon,label="Apply Trigger\nCommand"];
                        }

                        subgraph cluster_ro {
                                label="Readout system";
                                graph[color=deeppink2];
                                br[label="Board Reader"];
                        }
                }

                subgraph cluster_apa2 {
                        label="APA 2 Data and Trigger Flow";
                        graph[color=deeppink3];

                        subgraph cluster_fe2 {
                                label="Pre-Processing system";
                                graph[color=deeppink1];
                                fe2[label="DAQ Front End"];
                                pipe2[label="Trigger Primitive\nPipeline"];
                        }
                        subgraph cluster_buf2 {
                                label="Buffering system";
                                labelloc=top;
                                graph[color=deeppink1, ranksep=.8, nodesep=.25];
                                buf2[label="10s RAM\nbuffer"];
                                snb2[label="SNB dump"];
                                ro2[shape=hexagon,label="Apply Trigger\nCommand"];
                                {rank=same
                                ro2->snb2[style=invis];}
                                
                        }
                        subgraph cluster_ro2 {
                                label="Readout system";
                                graph[color=deeppink2];
                                br2[label="Board Reader"];
                        }
                }
                
                subgraph cluster_eb {
                        label="Single-Phase\nEgress Processing system";
                        graph[color=deeppink1, ranksep=.8, nodesep=.25];

                        eb[label="Event Builder"];
                        fp[label="Further Processing"];
                        dbuf[label="Disk Buffer"];
                }
        }
        // Full data
        edge[penwidth=8];
        CE1->WIB1;
        CE2->WIB2;
        CEi->WIBi
        CEj->WIBj;
        WIB1->fe[label="  80 Gbps"];
        WIB2->fe2[label=" 80 Gbps"];
        fe->buf//[headlabel="full data\n(possibly\ncompressed)\n\n"];
        fe2->buf2[label="full data\n(possibly\ncompressed)\n\n"];
        
        buf->snb;
        buf2->snb2;
        

        // collection plane data
        edge[penwidth=4];
        fe->pipe[label="960\n collection\nchannels"];
        fe2->pipe2// [label="960\n collection\nchannels"];

        // reduced data
        edge[pendwidth=2]
        buf->br[headlabel=" selected\n data\n "];
        buf2->br2[headlabel=" selected data\n "]
        
        br->eb;
        br2->eb;

        eb->fp->dbuf;

        // trickle
        edge[penwidth=1,style=solid];
        snb->br[constraint=false,label="trickle out                "];
        snb2->br2[constraint=false,label="trickle out"];
        

        // trigger primitive
        edge[penwidth=1,style=dashed];
        pipe:se->trig[label="trigger primitives"];
        pipe2:sw->trig;

        // trigger command
        edge[style=solid];
        trig->ro[label="trigger command"];
        trig->ro2[label="trigger command"];

        // influence layout
        edge[style=invis];

        trig->br;
        trig->br2;

        buf->ro;
        buf2->ro2;
        
        ro->br;
        ro2->br2;        
}